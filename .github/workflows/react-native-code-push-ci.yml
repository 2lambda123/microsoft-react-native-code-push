name: React-native-code-push CI

on:
  pull_request:
    branches:
      - master

jobs:
  test-android:
    name: Test Android app
    runs-on: macos-latest
    strategy:
      matrix:
        api-level: [ 27 ]
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Start adb server
        run: adb devices
      - name: Gradle cache
        uses: gradle/gradle-build-action@v2
      - name: AVD cache
        uses: actions/cache@v3
        id: avd-cache
        with:
          path: |
            ~/.android/avd/*
            ~/.android/adb*
          key: avd-${{ matrix.api-level }}
      - name: create AVD and generate snapshot for caching
        if: steps.avd-cache.outputs.cache-hit != 'true'
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ matrix.api-level }}
          arch: 'x86'
          target: 'google_apis'
          avd-name: 'TestEmulator'
          profile: 'Nexus 6P'
          force-avd-creation: true
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-snapshot-save -no-boot-anim
          disable-animations: true
          ram-size: 6144
          script: echo "Generated AVD snapshot for caching."
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'microsoft'
          java-version: '11'
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '2.7.5'
          bundler-cache: true
      - name: Package Installation
        run: npm i
      - name: Install react-native
        run: npm install -g react-native
      - name: Setup Android tests
        run: npm run build:tests && npm run test:setup:android
      - name: Remove react-native
        run: npm remove -g react-native
      - name: Install react-native-cli
        run: npm install -g react-native-cli
      - name: Run Android test
        run: npm run test:fast:android

  test-iOS:
    name: Test iOS app
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Install dependecies
        run: npm install
      - name: Install react-native-cli
        run: npm install react-native-cli
      - name: Install reacti-native
        run: npm install react-native
      - name: Build tests
        run: npm run build:tests
      - name: Setup tests
        run: npm run test:setup:ios
      - name: Run tests
        run: npm run test:fast:ios
